<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RNGNBA Draft</title>
  <style>
    /* General Styling */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    /* Styling for select dropdowns and buttons */
    select, button {
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
      margin: 5px;
    }
    button[type="submit"] {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    button[type="submit"]:hover {
      background-color: #0056b3;
    }
    /* Small buttons for actions */
    .small-btn {
      padding: 5px 8px;
      font-size: 14px;
      border-radius: 8px;
      margin-top: 5px;
    }
    /* Table Styling */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      border: 1px solid #ccc;
    }
    th, td {
      padding: 6px;
      border: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background-color: #f4f4f4;
    }
    /* Draft team colors */
    #team1Draft tr {
      background-color: lightblue;
    }
    #team2Draft tr {
      background-color: lightcoral;
    }
    /* Layout */
    .container {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .box {
      width: 48%;
    }
    /* Draft indicator */
    #currentDraft {
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0;
    }
    /* Player cell styling - now 20% width for 5 cells per row */
    .player-cell {
      width: 20%;
    }
    /* Modal styling */
    #confirmationModal {
      display: none; /* Hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    #modalContent {
      width: 300px;
      margin: 150px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    #modalContent button {
      margin: 10px;
    }
  </style>
</head>
<body>
  <h1>NBA All-Time Draft</h1>
  <!-- Current Draft Turn Indicator -->
  <div id="currentDraft">Current Draft Pick: Team 1</div>

  <form onsubmit="fetchPlayers(event)">
    <label for="team">Select Team:</label>
    <select id="team" name="team" onchange="updateYears()"></select>
    <label for="year">Select Year:</label>
    <select id="year" name="year">
      <option value="">--Choose Year--</option>
    </select>
    <button type="submit">Search</button>
  </form>

  <!-- Available players (search results) -->
  <h2>NBA Player Search Results</h2>
  <table id="searchResultsTable">
    <tbody id="playerResults"></tbody>
  </table>

  <!-- Container for draft teams -->
  <div class="container">
    <div class="box">
      <h2>Team 1 Draft</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>RNG Score</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="team1Draft"></tbody>
      </table>
    </div>
    <div class="box">
      <h2>Team 2 Draft</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>RNG Score</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="team2Draft"></tbody>
      </table>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal">
    <div id="modalContent">
      <p id="modalMessage">Draft ?</p>
      <button id="modalYes" class="small-btn">Yes</button>
      <button id="modalNo" class="small-btn">No</button>
    </div>
  </div>

  <script>
    // Global state for draft functionality.
    let currentTurn = 1;
    const maxPlayers = 5;
    let team1Count = 0;
    let team2Count = 0;
    // Object to store the original ordering of players.
    const originalPlayerIndices = {};
    // Global variable to hold a pending selection event.
    let pendingSelectEvent = null;

    // Dynamic teams array and team-to-year mappings.
    const teams = [
      "76ers", "Bucks", "Bulls", "Cavaliers", "Celtics", "Clippers", "Grizzlies",
      "Hawks", "Heat", "Hornets", "Jazz", "Kings", "Knicks", "Lakers", "Magic",
      "Mavericks", "Nets", "Nuggets", "Pacers", "Pelicans", "Pistons", "Raptors",
      "Rockets", "Spurs", "Suns", "Thunder", "Timberwolves", "Trail Blazers",
      "Warriors", "Wizards"
    ];
    const startYear = 1976;
    const endYear = 2024;
    const teamYears = Object.fromEntries(
      teams.map(team => [team, Array.from({ length: endYear - startYear + 1 }, (_, i) => startYear + i)])
    );

    // Populate the team dropdown dynamically.
    function populateTeamSelect() {
      const teamSelect = document.getElementById("team");
      teamSelect.innerHTML = "<option value=''>--Choose Team--</option>";
      teams.forEach(team => {
        const option = document.createElement("option");
        option.value = team;
        option.textContent = team;
        teamSelect.appendChild(option);
      });
    }
    document.addEventListener("DOMContentLoaded", function() {
      populateTeamSelect();
      updateDraftIndicator(); // Set initial search table color (blue for Team 1)
    });

    // Update the year dropdown, preserving the previous selection if valid.
    function updateYears() {
      const team = document.getElementById("team").value;
      const yearSelect = document.getElementById("year");
      const previousYear = yearSelect.value;
      yearSelect.innerHTML = '<option value="">--Choose Year--</option>';
      if (teamYears[team]) {
        teamYears[team].forEach(year => {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });
        if (teamYears[team].includes(Number(previousYear))) {
          yearSelect.value = previousYear;
        }
      }
    }

    // Update the draft indicator text and the search results table background.
    function updateDraftIndicator() {
      const indicator = document.getElementById("currentDraft");
      const searchResultsTable = document.getElementById("searchResultsTable");
      if (currentTurn === 1) {
        indicator.textContent = "Current Draft Pick: Team 1";
        searchResultsTable.style.backgroundColor = "lightblue";
      } else if (currentTurn === 2) {
        indicator.textContent = "Current Draft Pick: Team 2";
        searchResultsTable.style.backgroundColor = "lightcoral";
      } else {
        indicator.textContent = "Draft Complete!";
        searchResultsTable.style.backgroundColor = "white";
      }
    }

    // Fetch and display players based on team and year selection.
    // The display name includes the last two digits of the selected year.
    function fetchPlayers(event) {
      event.preventDefault();
      let team = document.getElementById("team").value;
      const year = document.getElementById("year").value;
      console.log("Selected Team:", team);
      console.log("Selected Year:", year);
      // Include historic Seattle data when selecting 'Thunder'
      if (team === "Thunder" & year < 2008) {
        console.log("switched thunder and sonics");
        team = "SuperSonics";
      }
      fetch(`http://127.0.0.1:5000/get_players?team=${team}&year=${year}`)
        .then(response => response.json())
        .then(data => {
          const results = document.getElementById("playerResults");
          results.innerHTML = "";
          // Reset the ordering map.
          for (const key in originalPlayerIndices) { delete originalPlayerIndices[key]; }
          if (data.length === 0) {
            results.innerHTML = `<tr><td colspan="5">No players found for the selected team and year.</td></tr>`;
            return;
          }
          let currentRow = null;
          data.forEach((player, index) => {
            if (index % 5 === 0) {
              currentRow = document.createElement("tr");
              results.appendChild(currentRow);
            }
            const displayName = `${year.slice(-2)} ${player.firstName} ${player.lastName}`;
            const key = `${player.firstName}-${year}-${player.lastName}`;
            originalPlayerIndices[key] = index;
            let cell = document.createElement("td");
            cell.classList.add("player-cell");
            cell.setAttribute("data-index", index);
            cell.innerHTML = `
              <button class="small-btn select-btn"
                      data-firstname="${player.firstName}"
                      data-lastname="${player.lastName}"
                      data-year="${year}"
                      data-score="${player.avgRNGscore}">
                ${displayName}
              </button>
            `;
            currentRow.appendChild(cell);
          });
          if (currentRow && currentRow.children.length < 5) {
            while (currentRow.children.length < 5) {
              let emptyCell = document.createElement("td");
              emptyCell.classList.add("player-cell");
              currentRow.appendChild(emptyCell);
            }
          }
        })
        .catch(error => console.error("Error fetching data:", error));
    }

    // Global event delegation for clicks.
    document.addEventListener("click", function(e) {
      if (e.target && e.target.classList.contains("select-btn")) {
        confirmDraft(e);
      } else if (e.target && e.target.classList.contains("remove-btn")) {
        removePlayer(e);
      }
    });

    // Show confirmation modal and store the pending event.
    function confirmDraft(e) {
      e.preventDefault();
      pendingSelectEvent = e;
      const button = e.target;
      const firstName = button.getAttribute("data-firstname");
      const lastName = button.getAttribute("data-lastname");
      const year = button.getAttribute("data-year");
      const displayName = `${year.slice(-2)} ${firstName} ${lastName}`;
      document.getElementById("modalMessage").textContent = `Draft ${displayName}?`;
      document.getElementById("confirmationModal").style.display = "block";
    }

    // Modal button handlers.
    document.getElementById("modalYes").addEventListener("click", function() {
      if (pendingSelectEvent) {
        selectPlayer(pendingSelectEvent);
      }
      document.getElementById("confirmationModal").style.display = "none";
      pendingSelectEvent = null;
    });
    document.getElementById("modalNo").addEventListener("click", function() {
      document.getElementById("confirmationModal").style.display = "none";
      pendingSelectEvent = null;
    });

    // Process player selection.
    function selectPlayer(event) {
      const button = event.target;
      const firstName = button.getAttribute("data-firstname");
      const lastName = button.getAttribute("data-lastname");
      const year = button.getAttribute("data-year");
      const avgRNGscore = button.getAttribute("data-score");
      const displayName = `${year.slice(-2)} ${firstName} ${lastName}`;
      const draftId = `draft-${year}-${firstName}-${lastName}`;
      if (document.getElementById(draftId)) {
        button.closest("td").remove();
        return;
      }
      if (currentTurn === 1 && team1Count >= maxPlayers) {
        alert("Team 1 is already full!");
        return;
      }
      if (currentTurn === 2 && team2Count >= maxPlayers) {
        alert("Team 2 is already full!");
        return;
      }
      let targetTeam;
      if (currentTurn === 1) {
        targetTeam = document.getElementById("team1Draft");
        team1Count++;
      } else {
        targetTeam = document.getElementById("team2Draft");
        team2Count++;
      }
      let row = document.createElement("tr");
      row.id = draftId;
      row.innerHTML = `
        <td>${displayName}</td>
        <td>${parseFloat(avgRNGscore).toFixed(2)}</td>
        <td>
          <button class="small-btn remove-btn"
                  data-firstname="${firstName}"
                  data-lastname="${lastName}"
                  data-year="${year}"
                  data-score="${avgRNGscore}">
            Remove
          </button>
        </td>
      `;
      targetTeam.appendChild(row);
      const playerCell = button.closest("td");
      if (playerCell && playerCell.parentElement) {
        playerCell.remove();
        reRenderSearchResults();
      }
      toggleTurn();
      updateTotalScores();
    }

    // Toggle the draft turn and update the search results table background.
    function toggleTurn() {
      if (team1Count < maxPlayers || team2Count < maxPlayers) {
        currentTurn = (currentTurn === 1) ? 2 : 1;
      } else {
        currentTurn = null;
      }
      updateDraftIndicator();
    }

    // Remove a drafted player and return them to the search results.
    function removePlayer(event) {
      const button = event.target;
      const firstName = button.getAttribute("data-firstname");
      const lastName = button.getAttribute("data-lastname");
      const year = button.getAttribute("data-year");
      const avgRNGscore = button.getAttribute("data-score");
      const teamRow = button.closest("tr");
      const parentTableId = teamRow.parentElement.id;
      if (parentTableId === "team1Draft") {
        team1Count--;
        currentTurn = 1;
      } else if (parentTableId === "team2Draft") {
        team2Count--;
        currentTurn = 2;
      }
      teamRow.remove();
      const results = document.getElementById("playerResults");
      let newCell = document.createElement("td");
      const key = `${firstName}-${year}-${lastName}`;
      newCell.classList.add("player-cell");
      newCell.setAttribute("data-index", originalPlayerIndices[key]);
      newCell.innerHTML = `
        <button class="small-btn select-btn"
                data-firstname="${firstName}"
                data-lastname="${lastName}"
                data-year="${year}"
                data-score="${avgRNGscore}">
          ${year.slice(-2)} ${firstName} ${lastName}
        </button>
      `;
      let lastRow = results.lastElementChild;
      if (!lastRow || lastRow.children.length >= 5) {
        lastRow = document.createElement("tr");
        results.appendChild(lastRow);
      }
      lastRow.appendChild(newCell);
      reRenderSearchResults();
      updateDraftIndicator();
      updateTotalScores();
    }

    // Reassemble the search results table so that players appear in their original order.
    function reRenderSearchResults() {
      const resultsTbody = document.getElementById("playerResults");
      let cells = [];
      const rows = resultsTbody.querySelectorAll("tr");
      rows.forEach(row => {
        row.querySelectorAll("td").forEach(cell => {
          if (cell.hasAttribute("data-index")) {
            cells.push(cell);
          }
        });
      });
      cells.sort((a, b) =>
        parseInt(a.getAttribute("data-index"), 10) - parseInt(b.getAttribute("data-index"), 10)
      );
      resultsTbody.innerHTML = "";
      let currentRow = null;
      cells.forEach((cell, i) => {
        if (i % 5 === 0) {
          currentRow = document.createElement("tr");
          resultsTbody.appendChild(currentRow);
        }
        currentRow.appendChild(cell);
      });
      if (currentRow && currentRow.children.length < 5) {
        while (currentRow.children.length < 5) {
          let emptyCell = document.createElement("td");
          emptyCell.classList.add("player-cell");
          currentRow.appendChild(emptyCell);
        }
      }
    }

    // Display total RNGscore for each drafted team
    function updateTotalScores() {
  let team1Total = 0;
  let team2Total = 0;

  // Sum the RNG scores for Team 1
  document.querySelectorAll("#team1Draft tr td:nth-child(2)").forEach(cell => {
    team1Total += parseFloat(cell.textContent);
  });

  // Sum the RNG scores for Team 2
  document.querySelectorAll("#team2Draft tr td:nth-child(2)").forEach(cell => {
    team2Total += parseFloat(cell.textContent);
  });

  // Target both team headers correctly
  const headers = document.querySelectorAll(".box h2");
  if (headers.length >= 2) {
    headers[0].textContent = `Team 1 Draft (Total RNG: ${team1Total.toFixed(2)})`;
    headers[1].textContent = `Team 2 Draft (Total RNG: ${team2Total.toFixed(2)})`;
  }
}

  </script>
</body>
</html>