<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RNGNBA Draft</title>
  <style>
    /* General Styling */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    /* Dropdowns and Buttons */
    select, button {
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
      margin: 5px;
    }
    button[type="submit"] {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    button[type="submit"]:hover {
      background-color: #0056b3;
    }
    .small-btn {
      padding: 5px 8px;
      font-size: 14px;
      border-radius: 8px;
      margin-top: 5px;
    }
    /* Table Styling */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      border: 1px solid #ccc;
    }
    th, td {
      padding: 6px;
      border: 1px solid #ccc;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background-color: #f4f4f4;
    }
    /* Draft team colors */
    #team1Draft tr {
      background-color: lightblue;
    }
    #team2Draft tr {
      background-color: lightcoral;
    }
    /* Layout */
    .container {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .box {
      width: 48%;
    }
    /* Draft Indicator */
    #currentDraft {
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0;
    }
    /* Player Cell Styling â€“ ensure 5 cells/row */
    .player-cell {
      width: 20%;
    }
    /* Modal Styling */
    #confirmationModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    #modalContent {
      width: 300px;
      margin: 150px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    #modalContent button {
      margin: 10px;
    }
  </style>
</head>
<body>
  <h1>NBA All-Time Draft</h1>
  <div id="currentDraft">Current Draft Pick: Team 1</div>

  <form id="searchForm">
    <label for="team">Select Team:</label>
    <select id="team" name="team"></select>
    <label for="year">Select Year:</label>
    <select id="year" name="year">
      <option value="">--Choose Year--</option>
    </select>
    <button type="submit">Search</button>
  </form>

  <h2>NBA Player Search Results</h2>
  <table id="searchResultsTable">
    <tbody id="playerResults"></tbody>
  </table>

  <div class="container">
    <div class="box">
      <h2>Team 1 Draft</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>RNG Score</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="team1Draft"></tbody>
      </table>
    </div>
    <div class="box">
      <h2>Team 2 Draft</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>RNG Score</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="team2Draft"></tbody>
      </table>
    </div>
  </div>

  <div id="confirmationModal">
    <div id="modalContent">
      <p id="modalMessage">Draft ?</p>
      <button id="modalYes" class="small-btn">Yes</button>
      <button id="modalNo" class="small-btn">No</button>
    </div>
  </div>

  <script type="module">
    class DraftApp {
      constructor() {
        // Global State
        this.currentTurn = 1;
        this.maxPlayers = 5;
        this.teamCounts = { 1: 0, 2: 0 };
        this.originalPlayerIndices = new Map();
        this.pendingSelectEvent = null;

        // Cache DOM Elements
        this.team1DraftElem = document.getElementById("team1Draft");
        this.team2DraftElem = document.getElementById("team2Draft");
        this.playerResultsElem = document.getElementById("playerResults");
        this.currentDraftIndicator = document.getElementById("currentDraft");
        this.confirmationModal = document.getElementById("confirmationModal");
        this.modalMessageElem = document.getElementById("modalMessage");
        this.searchResultsTable = document.getElementById("searchResultsTable");
        this.teamSelectElem = document.getElementById("team");
        this.yearSelectElem = document.getElementById("year");
        this.searchForm = document.getElementById("searchForm");
        this.modalYes = document.getElementById("modalYes");
        this.modalNo = document.getElementById("modalNo");

        // Static Data: Teams and Available Years
        this.teams = [
          "76ers", "Bucks", "Bulls", "Cavaliers", "Celtics", "Clippers", "Grizzlies",
          "Hawks", "Heat", "Hornets", "Jazz", "Kings", "Knicks", "Lakers", "Magic",
          "Mavericks", "Nets", "Nuggets", "Pacers", "Pelicans", "Pistons", "Raptors",
          "Rockets", "Spurs", "Suns", "Thunder", "Timberwolves", "Trail Blazers",
          "Warriors", "Wizards"
        ];
        this.startYear = 1976;
        this.endYear = 2024;
        this.teamYears = Object.fromEntries(
          this.teams.map(team => [
            team,
            Array.from({ length: this.endYear - this.startYear + 1 }, (_, i) => this.startYear + i)
          ])
        );
      }

      init() {
        // Bind events and initialize UI
        this.bindEvents();
        this.populateDropdown(this.teamSelectElem, this.teams, "--Choose Team--");
        this.updateYearOptions();
        this.updateDraftIndicator();
      }

      bindEvents() {
        // Form submission for players fetch
        this.searchForm.addEventListener("submit", (e) => this.fetchPlayers(e));

        // Update year dropdown when team changes
        this.teamSelectElem.addEventListener("change", () => this.updateYearOptions());

        // Global event delegation for button clicks
        document.addEventListener("click", (e) => {
          if (e.target.matches(".select-btn")) {
            this.confirmDraft(e);
          } else if (e.target.matches(".remove-btn")) {
            this.removePlayer(e);
          }
        });

        // Modal button events using arrow functions
        this.modalYes.addEventListener("click", () => {
          this.pendingSelectEvent && this.selectPlayer(this.pendingSelectEvent);
          this.hideModal();
          this.pendingSelectEvent = null;
        });
        this.modalNo.addEventListener("click", () => {
          this.hideModal();
          this.pendingSelectEvent = null;
        });
      }

      populateDropdown(selectElem, options, defaultText) {
        selectElem.innerHTML =
          `<option value="">${defaultText}</option>` +
          options.map(opt => `<option value="${opt}">${opt}</option>`).join("");
      }

      createPlayerCellHTML(firstName, lastName, year, avgRNGscore, index) {
        const displayName = `${year.slice(-2)} ${firstName} ${lastName}`;
        return `<td class="player-cell" data-index="${index}">
                  <button class="small-btn select-btn"
                          data-firstname="${firstName}"
                          data-lastname="${lastName}"
                          data-year="${year}"
                          data-score="${avgRNGscore}">
                    ${displayName}
                  </button>
                </td>`;
      }

      updateYearOptions() {
        const team = this.teamSelectElem.value;
        const previousYear = this.yearSelectElem.value;
        if (this.teamYears[team]) {
          this.populateDropdown(this.yearSelectElem, this.teamYears[team], "--Choose Year--");
          if (this.teamYears[team].includes(Number(previousYear))) {
            this.yearSelectElem.value = previousYear;
          }
        } else {
          this.populateDropdown(this.yearSelectElem, [], "--Choose Year--");
        }
      }

      updateDraftIndicator() {
        if (this.currentTurn === 1) {
          this.currentDraftIndicator.textContent = "Current Draft Pick: Team 1";
          this.searchResultsTable.style.backgroundColor = "lightblue";
        } else if (this.currentTurn === 2) {
          this.currentDraftIndicator.textContent = "Current Draft Pick: Team 2";
          this.searchResultsTable.style.backgroundColor = "lightcoral";
        } else {
          this.currentDraftIndicator.textContent = "Draft Complete!";
          this.searchResultsTable.style.backgroundColor = "white";
        }
      }

      updateTotalScores() {
        const sumScores = (selector) =>
          Array.from(document.querySelectorAll(selector))
            .reduce((total, cell) => total + parseFloat(cell.textContent), 0);
        const team1Total = sumScores("#team1Draft tr td:nth-child(2)");
        const team2Total = sumScores("#team2Draft tr td:nth-child(2)");
        const headers = document.querySelectorAll(".box h2");
        if (headers.length >= 2) {
          headers[0].textContent = `Team 1 Draft (Total RNG: ${team1Total.toFixed(2)})`;
          headers[1].textContent = `Team 2 Draft (Total RNG: ${team2Total.toFixed(2)})`;
        }
      }

      updateDraftStatus() {
        this.updateDraftIndicator();
        this.updateTotalScores();
      }

      // Helper: Normalize team name for historic data.
      normalizeTeamName(team, year) {
        return team === "Thunder" && year < 2008 ? "SuperSonics" : team;
      }

      fetchPlayers(event) {
        event.preventDefault();
        let team = this.teamSelectElem.value;
        const year = this.yearSelectElem.value;
        team = this.normalizeTeamName(team, year);
        fetch(`http://127.0.0.1:5000/get_players?team=${team}&year=${year}`)
          .then(response => response.json())
          .then(data => {
            this.playerResultsElem.innerHTML = "";
            this.originalPlayerIndices.clear();
            if (!data.length) {
              this.playerResultsElem.innerHTML =
                `<tr><td colspan="5">No players found for the selected team and year.</td></tr>`;
              return;
            }
            let html = "";
            data.forEach((player, i) => {
              if (i % 5 === 0) html += "<tr>";
              const key = `${player.firstName}-${year}-${player.lastName}`;
              this.originalPlayerIndices.set(key, i);
              html += this.createPlayerCellHTML(
                player.firstName,
                player.lastName,
                year,
                player.avgRNGscore,
                i
              );
              if ((i + 1) % 5 === 0) html += "</tr>";
            });
            if (data.length % 5 !== 0) {
              html += Array.from({ length: 5 - (data.length % 5) }, () => `<td class="player-cell"></td>`).join('') + "</tr>";
            }
            this.playerResultsElem.innerHTML = html;
          })
          .catch(error => console.error("Error fetching data:", error));
      }

      confirmDraft(event) {
        event.preventDefault();
        this.pendingSelectEvent = event;
        const { firstname, lastname, year } = event.target.dataset;
        const displayName = `${year.slice(-2)} ${firstname} ${lastname}`;
        this.modalMessageElem.textContent = `Draft ${displayName}?`;
        this.showModal();
      }

      showModal() {
        this.confirmationModal.style.display = "block";
      }

      hideModal() {
        this.confirmationModal.style.display = "none";
      }

      selectPlayer(event) {
        const { firstname, lastname, year, score } = event.target.dataset;
        const draftId = `draft-${year}-${firstname}-${lastname}`;
        if (document.getElementById(draftId)) {
          event.target.closest("td").remove();
          return;
        }
        const teamNames = { 1: "Team 1", 2: "Team 2" };
        if (this.teamCounts[this.currentTurn] >= this.maxPlayers) {
          alert(`${teamNames[this.currentTurn]} is already full!`);
          return;
        }
        const targetTbody = this.currentTurn === 1 ? this.team1DraftElem : this.team2DraftElem;
        this.teamCounts[this.currentTurn]++;
        const rowHTML = `
          <tr id="${draftId}">
            <td>${year.slice(-2)} ${firstname} ${lastname}</td>
            <td>${parseFloat(score).toFixed(2)}</td>
            <td>
              <button class="small-btn remove-btn"
                      data-firstname="${firstname}"
                      data-lastname="${lastname}"
                      data-year="${year}"
                      data-score="${score}">
                Remove
              </button>
            </td>
          </tr>`;
        targetTbody.insertAdjacentHTML("beforeend", rowHTML);
        // Remove from search results
        const cell = event.target.closest("td");
        if (cell) {
          cell.remove();
          this.reRenderSearchResults();
        }
        this.toggleTurn();
        this.updateDraftStatus();
      }

      toggleTurn() {
        this.currentTurn =
          this.teamCounts[1] < this.maxPlayers && this.teamCounts[2] < this.maxPlayers
            ? this.currentTurn === 1 ? 2 : 1
            : this.teamCounts[1] < this.maxPlayers ? 1 : this.teamCounts[2] < this.maxPlayers ? 2 : null;
        this.updateDraftStatus();
      }

      removePlayer(event) {
        const { firstname, lastname, year, score } = event.target.dataset;
        const row = event.target.closest("tr");
        const parentId = row.parentElement.id;
        if (parentId === "team1Draft") {
          this.teamCounts[1]--;
          this.currentTurn = 1;
        } else if (parentId === "team2Draft") {
          this.teamCounts[2]--;
          this.currentTurn = 2;
        }
        row.remove();
        const key = `${firstname}-${year}-${lastname}`;
        const originalIndex = this.originalPlayerIndices.get(key);
        const cellHTML = this.createPlayerCellHTML(firstname, lastname, year, score, originalIndex);
        let lastRow = this.playerResultsElem.lastElementChild;
        if (!lastRow || lastRow.children.length >= 5) {
          this.playerResultsElem.insertAdjacentHTML("beforeend", `<tr>${cellHTML}</tr>`);
        } else {
          lastRow.insertAdjacentHTML("beforeend", cellHTML);
        }
        this.reRenderSearchResults();
        this.updateDraftStatus();
      }

      reRenderSearchResults() {
        const tbody = this.playerResultsElem;
        const cells = Array.from(tbody.querySelectorAll("td[data-index]"));
        cells.sort((a, b) => parseInt(a.getAttribute("data-index"), 10) - parseInt(b.getAttribute("data-index"), 10));
        let html = "";
        cells.forEach((cell, i) => {
          if (i % 5 === 0) html += "<tr>";
          html += cell.outerHTML;
          if ((i + 1) % 5 === 0) html += "</tr>";
        });
        if (cells.length % 5 !== 0) {
          html += Array.from({ length: 5 - (cells.length % 5) }, () => `<td class="player-cell"></td>`).join('') + "</tr>";
        }
        tbody.innerHTML = html;
      }
    }

    // Instantiate and initialize the Draft App
    const draftApp = new DraftApp();
    window.addEventListener("DOMContentLoaded", () => {
      draftApp.init();
    });
  </script>
</body>
</html>


